name: RDP

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: 🧲 تنزيل ngrok
        shell: powershell
        run: |
          Invoke-WebRequest "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip" -OutFile ngrok.zip
          Expand-Archive -Path ngrok.zip -DestinationPath .
          Get-ChildItem -Recurse -Filter "ngrok.exe"

      - name: 🔐 تعيين رمز مصادقة ngrok
        shell: powershell
        run: |
          $ngrokPath = Get-ChildItem -Recurse -Filter "ngrok.exe" | Select-Object -First 1 -ExpandProperty FullName
          if (-not $ngrokPath) {
            Write-Error "❌ لم يتم العثور على ngrok.exe"
            exit 1
          }
          & $ngrokPath authtoken "ضع_التوكن_الخاص_بك_هنا"

      - name: 🖥️ تفعيل RDP (المستخدم والمسؤول)
        shell: powershell
        run: |
          net user kamel123 MyStrong123 /add
          net localgroup administrators kamel123 /add
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: 🚀 تشغيل ngrok TCP 3389 في الخلفية
        shell: powershell
        run: |
          $ngrokPath = Get-ChildItem -Recurse -Filter "ngrok.exe" | Select-Object -First 1 -ExpandProperty FullName
          if (-not $ngrokPath) {
            Write-Error "❌ لم يتم العثور على ngrok.exe لتشغيل النفق"
            exit 1
          }

          $log = "$Env:RUNNER_TEMP\ngrok.log"
          Start-Process -FilePath $ngrokPath -ArgumentList "tcp 3389" -RedirectStandardOutput $log -RedirectStandardError $log -NoNewWindow
          Start-Sleep -Seconds 8

          if (Test-Path $log) {
            Write-Output "📄 سجل ngrok:"
            Get-Content $log -Tail 100
          } else {
            Write-Output "⚠️ لم يتم إنشاء سجل ngrok بعد."
          }

          # إبقاء الجلسة فعالة لبعض الوقت (2 دقائق تقريباً)
          Write-Output "⏳ إبقاء الجلسة فعالة لمدة 120 ثانية..."
          Start-Sleep -Seconds 120

      - name: ✅ إكمال المهمة
        shell: powershell
        run: Write-Output "🎉 المهمة اكتملت بنجاح!"
