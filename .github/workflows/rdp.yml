name: RDP

on: [workflow_dispatch]

jobs:
  rdp:
    runs-on: windows-latest

    steps:
      - name: 🧲 تحميل ngrok
        shell: powershell
        run: |
          Invoke-WebRequest "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip" -OutFile ngrok.zip
          Expand-Archive -Path ngrok.zip -DestinationPath .
          Get-ChildItem -Recurse -Filter "ngrok.exe" | Select-Object FullName

      - name: 🔐 تعيين رمز مصادقة ngrok
        shell: powershell
        run: |
          $ngrokPath = Get-ChildItem -Recurse -Filter "ngrok.exe" | Select-Object -First 1 -ExpandProperty FullName
          if (-not $ngrokPath) {
            Write-Error "❌ لم يتم العثور على ngrok.exe"
            exit 1
          }
          & $ngrokPath authtoken "33SvSKHkJLRsn36tZuPyFCTonRm_87acyWPUm5SHb282DTLeu"
          & $ngrokPath version

      - name: 🧑‍💻 تفعيل RDP وإضافة المستخدم
        shell: powershell
        run: |
          net user kamel123 MyStrong123 /add
          net localgroup administrators kamel123 /add
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: 🚀 تشغيل ngrok TCP 3389 بالخلفية وتسجيل المخرجات
        shell: powershell
        run: |
          $ngrokPath = Get-ChildItem -Recurse -Filter "ngrok.exe" | Select-Object -First 1 -ExpandProperty FullName
          if (-not $ngrokPath) {
            Write-Error "❌ ngrok.exe غير موجود"
            exit 1
          }

          $stdout = "$Env:RUNNER_TEMP\ngrok_stdout.log"
          $stderr = "$Env:RUNNER_TEMP\ngrok_stderr.log"

          Start-Process -FilePath $ngrokPath -ArgumentList "tcp 3389" `
            -RedirectStandardOutput $stdout `
            -RedirectStandardError $stderr `
            -NoNewWindow -PassThru

          Start-Sleep -Seconds 10

          Write-Output "`n📄 ngrok STDOUT:"
          if (Test-Path $stdout) {
            Get-Content $stdout -Tail 100
          } else {
            Write-Output "لم يتم العثور على سجل ngrok stdout."
          }

          Write-Output "`n⚠️ ngrok STDERR:"
          if (Test-Path $stderr) {
            Get-Content $stderr -Tail 100
          }

          # إبقاء الجلسة فعالة لمدة 3 دقائق
          Write-Output "`n⏳ إبقاء الجلسة فعالة لمدة 180 ثانية..."
          Start-Sleep -Seconds 180

      - name: ✅ إنهاء المهمة
        shell: powershell
        run: Write-Output "🎉 تم تنفيذ كل الخطوات بنجاح!"
