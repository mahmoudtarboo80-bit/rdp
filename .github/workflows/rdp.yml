name: RDP

on: [workflow_dispatch]

jobs:
  rdp:
    runs-on: windows-latest

    steps:
      - name: ğŸ§² ØªØ­Ù…ÙŠÙ„ ngrok
        shell: powershell
        run: |
          Invoke-WebRequest "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip" -OutFile ngrok.zip
          Expand-Archive -Path ngrok.zip -DestinationPath .
          Get-ChildItem -Recurse -Filter "ngrok.exe" | Select-Object FullName

      - name: ğŸ” ØªØ¹ÙŠÙŠÙ† Ø±Ù…Ø² Ù…ØµØ§Ø¯Ù‚Ø© ngrok
        shell: powershell
        run: |
          $ngrokPath = Get-ChildItem -Recurse -Filter "ngrok.exe" | Select-Object -First 1 -ExpandProperty FullName
          if (-not $ngrokPath) {
            Write-Error "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ngrok.exe"
            exit 1
          }
          & $ngrokPath authtoken "33SvSKHkJLRsn36tZuPyFCTonRm_87acyWPUm5SHb282DTLeu"
          & $ngrokPath version

      - name: ğŸ§‘â€ğŸ’» ØªÙØ¹ÙŠÙ„ RDP ÙˆØ¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…
        shell: powershell
        run: |
          net user kamel123 MyStrong123 /add
          net localgroup administrators kamel123 /add
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: ğŸš€ ØªØ´ØºÙŠÙ„ ngrok TCP 3389 Ø¨Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„
        shell: powershell
        run: |
          $ngrokPath = Get-ChildItem -Recurse -Filter "ngrok.exe" | Select-Object -First 1 -ExpandProperty FullName
          if (-not $ngrokPath) {
            Write-Error "âŒ ngrok.exe ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
            exit 1
          }

          $stdout = "$Env:RUNNER_TEMP\ngrok_stdout.log"
          $stderr = "$Env:RUNNER_TEMP\ngrok_stderr.log"

          # ØªØ´ØºÙŠÙ„ ngrok ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬ ÙÙŠ Ù…Ù„ÙÙŠÙ† Ù…Ø®ØªÙ„ÙÙŠÙ†
          Start-Process -FilePath $ngrokPath -ArgumentList "tcp 3389" `
            -RedirectStandardOutput $stdout `
            -RedirectStandardError $stderr `
            -NoNewWindow -PassThru

          Start-Sleep -Seconds 10

          Write-Output "`nğŸ“„ ngrok STDOUT:"
          if (Test-Path $stdout) {
            Get-Content $stdout -Tail 100
          } else {
            Write-Output "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬."
          }

          Write-Output "`nâš ï¸ ngrok STDERR:"
          if (Test-Path $stderr) {
            Get-Content $stderr -Tail 100
          }

          # Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© ÙØ¹Ø§Ù„Ø© 3 Ø¯Ù‚Ø§Ø¦Ù‚ (ÙŠÙ…ÙƒÙ†Ùƒ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆÙ‚Øª Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª)
          Write-Output "`nâ³ Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© ÙØ¹Ø§Ù„Ø© Ù„Ù…Ø¯Ø© 180 Ø«Ø§Ù†ÙŠØ©..."
          Start-Sleep -Seconds 180

      - name: âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©
        shell: powershell
        run: Write-Output "ğŸ‰ ØªÙ… ØªÙ†ÙÙŠØ° Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø¨Ù†Ø¬Ø§Ø­"
